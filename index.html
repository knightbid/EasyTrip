<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chia Tiền Đi Chơi (TripSplit AI) - Firebase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#4F46E5',
              secondary: '#10B981',
              danger: '#EF4444',
            },
            animation: {
              'fade-in-down': 'fadeInDown 0.3s ease-out',
              'fade-in-up': 'fadeInUp 0.3s ease-out',
            },
            keyframes: {
              fadeInDown: {
                '0%': { opacity: '0', transform: 'translateY(-10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
            }
          }
        }
      }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Loading Overlay */
        #global-loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px); transition: opacity 0.3s;
        }
        .hidden-loader { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased min-h-screen flex flex-col">

    <!-- Setup Check Script -->
    <script>
        // Shim for process.env to avoid errors
        window.process = { env: { API_KEY: '' } };

        // Check if running via file:// protocol
        if (window.location.protocol === 'file:') {
            console.warn("Running via file:// protocol. Some features might be limited.");
        }
    </script>

    <!-- Loader -->
    <div id="global-loader">
        <div class="flex flex-col items-center text-center p-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-3"></div>
            <p class="text-indigo-600 font-medium animate-pulse" id="loader-text">Đang kết nối Firebase...</p>
            <p class="text-xs text-gray-400 mt-2 max-w-xs">Nếu quá lâu, hãy kiểm tra kết nối mạng.</p>
        </div>
    </div>

    <div id="app" class="flex-1">
        <!-- App Content will be injected here -->
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- Main Logic Script (Inlined to fix CORS issues) -->
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { 
            initializeFirestore, collection, onSnapshot, 
            addDoc, doc, updateDoc, deleteDoc, 
            serverTimestamp 
        } from "firebase/firestore";
        import { GoogleGenAI, Type } from "@google/genai";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5TIQ65Svby10oRmmObxhr0-4h4f8GRN8",
            authDomain: "sending-5a2ed.firebaseapp.com",
            projectId: "sending-5a2ed",
            storageBucket: "sending-5a2ed.firebasestorage.app",
            messagingSenderId: "277993628196",
            appId: "1:277993628196:web:37ba3db909a6d5398e6eb1"
        };

        // Initialize Firebase
        let db;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            console.log("Firebase App initialized:", firebaseApp.name);
            
            // Initialize Firestore with settings optimized for basic web usage
            db = initializeFirestore(firebaseApp, {
                // Default settings work best for CDN usage
            });
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            const loaderText = document.getElementById('loader-text');
            if(loaderText) loaderText.innerText = "Lỗi kết nối Firebase. Vui lòng tải lại.";
        }

        const TRIPS_COLLECTION = 'trips';

        // --- API KEY & CONFIG ---
        const API_KEY = window.process?.env?.API_KEY || '';

        // --- UTILS ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
            }).format(amount);
        };

        const generateId = () => Math.random().toString(36).substring(2, 9);

        const getRandomImage = (width, height, seed) => {
            return `https://picsum.photos/seed/${seed}/${width}/${height}`;
        };

        const encodeData = (data) => {
            try {
                return btoa(encodeURIComponent(JSON.stringify(data)).replace(/%([0-9A-F]{2})/g,
                    (match, p1) => String.fromCharCode(parseInt(p1, 16))));
            } catch (e) { console.error(e); return ""; }
        };

        const decodeData = (str) => {
            try {
                return JSON.parse(decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('')));
            } catch (e) { console.error(e); return null; }
        };

        // --- STATE MANAGEMENT ---
        const store = {
            trips: [],
            activeTripId: null,
            isReadOnly: false,
            activeTab: 'expenses',
            editingExpenseId: null,
            expenseModalOpen: false,
            isCreating: false,
            newTripName: '',
            newMemberName: '',
            quickAddText: '',
            isAnalyzing: false,
            expenseForm: { desc: '', amount: '', payerId: '', involvedIds: [] }
        };

        // --- FIREBASE OPERATIONS ---

        // 1. Listen to Trips (Real-time)
        const initFirebaseListener = () => {
            const loader = document.getElementById('global-loader');
            const loaderText = document.getElementById('loader-text');
            
            if (!db) {
                // Fallback if DB failed to init
                console.warn("DB not initialized, rendering empty state.");
                render();
                if(loader) loader.classList.add('hidden-loader');
                return;
            }
            
            const q = collection(db, TRIPS_COLLECTION);
            
            console.log("Listening to 'trips'...");
            
            // Safety Timeout: If Firebase hangs for 5 seconds, let the user enter the app anyway
            const safetyTimeout = setTimeout(() => {
                if (loader && !loader.classList.contains('hidden-loader')) {
                    console.warn("Firebase connection taking too long. Hiding loader.");
                    loaderText.innerText = "Kết nối chậm. Đang vào chế độ offline...";
                    setTimeout(() => {
                        render(); 
                        loader.classList.add('hidden-loader');
                    }, 1000);
                }
            }, 5000);

            onSnapshot(q, (snapshot) => {
                clearTimeout(safetyTimeout);
                console.log("Snapshot received. Docs:", snapshot.size);
                
                const tripsData = [];
                snapshot.forEach((doc) => {
                    tripsData.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by createdAt descending (newest first)
                store.trips = tripsData.sort((a,b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                checkShareLink();
                
                render();
                if(loader) loader.classList.add('hidden-loader');
            }, (error) => {
                clearTimeout(safetyTimeout);
                console.error("Firebase Error:", error);
                
                if (error.code === 'permission-denied') {
                    alert("Lỗi quyền truy cập (CORS/Rules). Vui lòng kiểm tra Firebase Rules.");
                }
                
                render(); // Render empty state at least
                if(loader) loader.classList.add('hidden-loader');
            });
        };

        const checkShareLink = () => {
            const hash = window.location.hash;
            if (hash.startsWith('#share=') && !store.activeTripId) {
                try {
                    const encoded = hash.substring(7);
                    const sharedTrip = decodeData(encoded);
                    if (sharedTrip && sharedTrip.id) {
                        store.activeTripId = sharedTrip.id;
                        store.isReadOnly = true;
                        if (!store.trips.find(t => t.id === sharedTrip.id)) {
                            store.trips.push(sharedTrip);
                        }
                    }
                } catch(e) { console.error(e); }
            }
        };

        const createTripInDB = async (name) => {
            try {
                const newTrip = {
                    name: name,
                    startDate: new Date().toISOString(),
                    coverImage: getRandomImage(600, 400, name),
                    members: [],
                    expenses: [],
                    createdAt: serverTimestamp()
                };
                const docRef = await addDoc(collection(db, TRIPS_COLLECTION), newTrip);
                store.isCreating = false;
                store.newTripName = '';
                store.activeTripId = docRef.id;
                render();
            } catch (e) {
                console.error("Error adding trip: ", e);
                alert("Lỗi tạo chuyến đi. Kiểm tra Console.");
            }
        };

        const updateTripInDB = async (trip) => {
            if (!trip || !trip.id || store.isReadOnly) return;
            try {
                const tripRef = doc(db, TRIPS_COLLECTION, trip.id);
                const { id, ...dataToSave } = trip;
                await updateDoc(tripRef, dataToSave);
            } catch (e) {
                console.error("Error updating trip: ", e);
            }
        };

        const deleteTripFromDB = async (id) => {
            if (!id || store.isReadOnly) return;
            try {
                await deleteDoc(doc(db, TRIPS_COLLECTION, id));
                if (store.activeTripId === id) store.activeTripId = null;
            } catch (e) {
                console.error("Error deleting trip: ", e);
                alert("Không thể xóa chuyến đi.");
            }
        };

        // --- AI SERVICE ---
        const parseExpenseWithAI = async (text, memberNames) => {
            if (!API_KEY) {
                alert("Chưa cấu hình API Key! Vui lòng kiểm tra metadata.json hoặc cấu hình môi trường.");
                return null;
            }
            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const prompt = `
                Phân tích chi tiêu: "${text}".
                Thành viên: ${memberNames.join(", ")}.
                Nếu tên người trả không có trong danh sách, hãy chọn người có tên gần giống nhất hoặc để trống.
                Trả về JSON thuần túy không markdown.
                `;

                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                description: { type: Type.STRING, description: "Mô tả khoản chi" },
                                amount: { type: Type.NUMBER, description: "Số tiền" },
                                payerName: { type: Type.STRING, description: "Tên người trả" },
                            },
                            required: ["description", "amount", "payerName"],
                        },
                    },
                });
                return JSON.parse(response.text);
            } catch (e) {
                console.error("AI Error", e);
                alert("Lỗi AI: " + e.message);
                return null;
            }
        };

        // --- RENDER ---
        const app = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');

        const renderTripList = () => {
            const tripsHtml = store.trips.length === 0 
                ? `<div class="text-center py-16 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 col-span-full">
                    <p class="text-gray-500 text-lg mb-4">Chưa có chuyến đi nào.</p>
                    <button data-action="toggle-create-form" class="text-indigo-600 font-medium hover:underline">Tạo chuyến đi ngay!</button>
                </div>`
                : store.trips.map(trip => `
                    <div class="group bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden border border-gray-200 flex flex-col h-full">
                        <div class="relative h-40 overflow-hidden cursor-pointer" data-action="select-trip" data-id="${trip.id}">
                            <img src="${trip.coverImage}" alt="${trip.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <h3 class="absolute bottom-3 left-4 text-xl font-bold text-white shadow-black/50 drop-shadow-md">${trip.name}</h3>
                        </div>
                        <div class="p-4 flex-1 flex flex-col">
                            <div class="flex items-center text-gray-500 text-sm mb-2">
                                <i data-lucide="calendar" class="w-4 h-4 mr-2"></i> ${new Date(trip.startDate).toLocaleDateString('vi-VN')}
                            </div>
                            <div class="flex items-center text-gray-500 text-sm mb-4">
                                <i data-lucide="users" class="w-4 h-4 mr-2"></i> ${trip.members ? trip.members.length : 0} thành viên
                            </div>
                            <div class="mt-auto flex justify-between items-center pt-4 border-t border-gray-100">
                                <button data-action="select-trip" data-id="${trip.id}" class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-3 py-1 rounded text-xs font-medium transition-colors">Xem Chi Tiết</button>
                                <button data-action="delete-trip" data-id="${trip.id}" class="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');

            return `
                <div class="container mx-auto px-4 py-8 max-w-5xl">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">Chuyến Đi Của Bạn</h1>
                        <button data-action="toggle-create-form" class="bg-indigo-600 text-white px-4 py-2 rounded-md flex items-center gap-2 hover:bg-indigo-700 transition-colors shadow-sm">
                            <i data-lucide="plus" class="w-5 h-5"></i> Tạo Chuyến Đi
                        </button>
                    </div>
                    <div id="create-trip-form" class="${store.isCreating ? 'block' : 'hidden'} mb-8 bg-white p-6 rounded-lg shadow-md border border-indigo-100 animate-fade-in-down">
                        <form data-action="submit-create-trip" class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="new-trip-input" value="${store.newTripName}" placeholder="Tên chuyến đi (VD: Đà Lạt 2024)" class="flex-1 rounded-md border border-gray-300 p-2 focus:ring-indigo-500 shadow-sm" />
                            <div class="flex gap-2">
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Lưu</button>
                                <button type="button" data-action="cancel-create" class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md hover:bg-gray-50">Hủy</button>
                            </div>
                        </form>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${tripsHtml}</div>
                </div>
            `;
        };

        const renderTripDetail = () => {
            const trip = store.trips.find(t => t.id === store.activeTripId);
            if (!trip) return '<div class="p-8 text-center">Không tìm thấy chuyến đi</div>';

            const expenses = trip.expenses || [];
            const members = trip.members || [];
            const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
            
            const memberStats = members.map(m => {
                let paid = 0;
                let consumed = 0;
                expenses.forEach(e => {
                    if (e.payerId === m.id) paid += e.amount;
                    const involved = (e.involvedMemberIds && e.involvedMemberIds.length > 0) ? e.involvedMemberIds : members.map(mem => mem.id);
                    if (involved.includes(m.id)) consumed += e.amount / involved.length;
                });
                return { ...m, paid, consumed, balance: paid - consumed };
            }).sort((a, b) => a.balance - b.balance);

            const renderExpensesTab = () => {
                const list = expenses.length === 0 
                    ? `<div class="text-center py-12 text-gray-400"><i data-lucide="receipt" class="w-12 h-12 mx-auto mb-2 opacity-20"></i><p>Chưa có khoản chi nào.</p></div>`
                    : expenses.map(e => {
                        const payer = members.find(m => m.id === e.payerId)?.name || 'Unknown';
                        const count = e.involvedMemberIds?.length || members.length;
                        return `
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-lg border border-gray-100 transition-colors group">
                            <div class="flex items-start gap-3 flex-1 ${!store.isReadOnly ? 'cursor-pointer' : ''}" data-action="${!store.isReadOnly ? 'edit-expense' : ''}" data-id="${e.id}">
                                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600 mt-1"><i data-lucide="receipt" class="w-5 h-5"></i></div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${e.description}</h4>
                                    <p class="text-sm text-gray-500"><span class="font-medium text-gray-700">${payer}</span> đã trả • <span class="text-gray-400 italic ml-1">${count === members.length ? 'Tất cả' : `Cho ${count} người`}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">${new Date(e.date).toLocaleDateString('vi-VN')}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3"><span class="font-bold text-gray-900">${formatCurrency(e.amount)}</span>${!store.isReadOnly ? `<button data-action="edit-expense" data-id="${e.id}" class="text-gray-400 hover:text-indigo-500 p-2"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button data-action="delete-expense" data-id="${e.id}" class="text-gray-400 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}</div>
                        </div>`;
                    }).join('');

                const quickAdd = !store.isReadOnly && members.length > 0 ? `
                    <div class="mb-8"><div class="relative">
                        <input type="text" id="quick-add-input" value="${store.quickAddText}" placeholder='Nhập nhanh: "Ăn tối 500k Hùng trả" ...' class="w-full pl-4 pr-32 py-3 rounded-full border border-gray-300 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none" ${store.isAnalyzing ? 'disabled' : ''} />
                        <div class="absolute right-1 top-1 bottom-1 flex items-center gap-1">
                            <button data-action="ai-quick-add" class="rounded-full h-full px-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white disabled:opacity-50">${store.isAnalyzing ? '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>' : '<i data-lucide="sparkles" class="w-4 h-4"></i>'}</button>
                            <button data-action="open-expense-modal" class="rounded-full h-full w-10 bg-gray-100 hover:bg-gray-200"><i data-lucide="plus" class="w-5 h-5 mx-auto"></i></button>
                        </div>
                    </div></div>` : '';
                return `<div>${quickAdd} <div class="space-y-4">${list}</div></div>`;
            };

            const renderBalancesTab = () => `
                <div class="space-y-6"><div class="grid gap-4">${memberStats.map(m => `
                    <div class="flex items-center justify-between p-4 bg-white border border-gray-100 rounded-lg shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold ${m.balance >= 0 ? 'bg-green-500' : 'bg-red-500'}">${m.name.charAt(0).toUpperCase()}</div>
                            <span class="font-medium text-lg">${m.name}</span>
                        </div>
                        <div class="text-lg font-bold ${m.balance > 0 ? 'text-green-600' : m.balance < 0 ? 'text-red-600' : 'text-gray-400'}">${m.balance > 0 ? '+' : ''}${formatCurrency(m.balance)}</div>
                    </div>`).join('')}</div></div>`;

            const renderReportTab = () => {
                const topSpender = [...memberStats].sort((a, b) => b.paid - a.paid)[0];
                return `
                    <div class="space-y-8 animate-fade-in-up">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200"><p class="text-blue-600 text-sm font-medium">Tổng Chi Phí</p><p class="text-2xl font-bold text-blue-900">${formatCurrency(totalSpent)}</p></div>
                            <div class="bg-purple-50 p-4 rounded-xl border border-purple-200"><p class="text-purple-600 text-sm font-medium">Bình Quân/Người</p><p class="text-2xl font-bold text-purple-900">${formatCurrency(members.length ? totalSpent/members.length : 0)}</p></div>
                            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200"><p class="text-amber-600 text-sm font-medium">Chi Nhiều Nhất</p><p class="text-xl font-bold text-amber-900">${topSpender && topSpender.paid > 0 ? topSpender.name : '---'}</p></div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50"><h3 class="font-bold text-gray-800">Chi tiết công nợ</h3></div>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50"><tr><th class="px-6 py-3">Thành viên</th><th class="px-6 py-3 text-right">Đã Chi</th><th class="px-6 py-3 text-right">Sử Dụng</th><th class="px-6 py-3 text-right">Chênh Lệch</th></tr></thead>
                                <tbody>${memberStats.map(m => `
                                    <tr class="bg-white border-b border-gray-100 hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium text-gray-900">${m.name}</td>
                                        <td class="px-6 py-4 text-right text-indigo-600">${formatCurrency(m.paid)}</td>
                                        <td class="px-6 py-4 text-right text-pink-600">${formatCurrency(m.consumed)}</td>
                                        <td class="px-6 py-4 text-right font-bold ${m.balance >= 0 ? 'text-green-600' : 'text-red-600'}">${m.balance > 0 ? '+' : ''}${formatCurrency(m.balance)}</td>
                                    </tr>`).join('')}</tbody>
                            </table></div>
                        </div>
                    </div>`;
            };

            const renderMembersTab = () => `
                <div>
                    ${!store.isReadOnly ? `<form data-action="add-member" class="flex gap-2 mb-6"><input type="text" id="new-member-input" value="${store.newMemberName}" placeholder="Tên thành viên mới..." class="flex-1 rounded-md border border-gray-300 p-2 shadow-sm" /><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Thêm</button></form>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${members.map(m => `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 font-bold text-xs">${m.name.charAt(0).toUpperCase()}</div><span class="font-medium">${m.name}</span></div>${!store.isReadOnly ? `<button data-action="remove-member" data-id="${m.id}" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}</div>`).join('')}</div>
                </div>`;

            let content = '';
            if (store.activeTab === 'expenses') content = renderExpensesTab();
            else if (store.activeTab === 'balances') content = renderBalancesTab();
            else if (store.activeTab === 'report') content = renderReportTab();
            else if (store.activeTab === 'members') content = renderMembersTab();

            const tabClass = (tab) => `flex-1 py-4 px-4 text-sm font-medium text-center border-b-2 whitespace-nowrap ${store.activeTab === tab ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`;

            return `
                <div class="container mx-auto px-4 py-6 max-w-4xl animate-fade-in-down">
                    ${store.isReadOnly ? `<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-blue-700"><i data-lucide="lock" class="w-4 h-4"></i><span class="text-sm font-medium">View Only Mode.</span></div><button data-action="enable-editing" class="bg-white text-blue-600 border border-blue-200 px-3 py-1 rounded text-xs font-medium hover:bg-blue-50 flex items-center gap-1"><i data-lucide="unlock" class="w-3 h-3"></i> Chỉnh sửa</button></div>` : ''}
                    <div class="mb-6">
                        <button data-action="back-to-list" class="text-gray-500 hover:text-indigo-600 flex items-center mb-4"><i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Quay lại</button>
                        <div class="bg-white rounded-2xl shadow-md overflow-hidden">
                            <div class="h-48 w-full relative">
                                <img src="${trip.coverImage}" class="w-full h-full object-cover" />
                                <div class="absolute inset-0 bg-black/30 flex items-end p-6">
                                    <div><h1 class="text-3xl font-bold text-white mb-1">${trip.name}</h1><p class="text-white/90 text-sm flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> ${members.length} thành viên • Tổng chi: <span class="font-bold text-green-300">${formatCurrency(totalSpent)}</span></p></div>
                                </div>
                                <button data-action="share-trip" class="absolute top-4 right-4 bg-white/20 backdrop-blur-sm p-2 rounded-full text-white hover:bg-white/40 transition-all"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                            </div>
                            <div class="flex border-b border-gray-200 overflow-x-auto">
                                <button data-action="switch-tab" data-tab="expenses" class="${tabClass('expenses')}"><div class="flex items-center justify-center gap-2"><i data-lucide="receipt" class="w-4 h-4"></i> Chi Tiêu</div></button>
                                <button data-action="switch-tab" data-tab="balances" class="${tabClass('balances')}"><div class="flex items-center justify-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Công Nợ</div></button>
                                <button data-action="switch-tab" data-tab="report" class="${tabClass('report')}"><div class="flex items-center justify-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Tổng kết</div></button>
                                <button data-action="switch-tab" data-tab="members" class="${tabClass('members')}"><div class="flex items-center justify-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Thành Viên</div></button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 min-h-[400px]">${content}</div>
                </div>`;
        };

        const renderExpenseModal = () => {
            if (!store.expenseModalOpen) return '';
            const trip = store.trips.find(t => t.id === store.activeTripId);
            if (!trip) return '';
            const members = trip.members || [];
            const involvedIds = store.expenseForm.involvedIds.length > 0 ? store.expenseForm.involvedIds : members.map(m => m.id);

            return `
                <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="close-modal"></div>
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="text-lg leading-6 font-medium text-gray-900">${store.editingExpenseId ? 'Sửa Khoản Chi' : 'Thêm Khoản Chi Mới'}</h3><button data-action="close-modal" class="text-gray-400 hover:text-gray-500"><i data-lucide="x" class="w-6 h-6"></i></button></div>
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label><input type="text" id="ex-desc" value="${store.expenseForm.desc}" class="w-full rounded-md border border-gray-300 p-2" placeholder="VD: Vé tham quan"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Số tiền (VNĐ)</label><input type="number" id="ex-amount" value="${store.expenseForm.amount}" class="w-full rounded-md border border-gray-300 p-2" placeholder="0"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Người trả</label><select id="ex-payer" class="w-full rounded-md border border-gray-300 p-2"><option value="">-- Chọn người trả --</option>${members.map(m => `<option value="${m.id}" ${m.id === store.expenseForm.payerId ? 'selected' : ''}>${m.name}</option>`).join('')}</select></div>
                                    <div><div class="flex justify-between items-center mb-2"><label class="block text-sm font-medium text-gray-700">Thành viên tham gia</label><button data-action="toggle-select-all" class="text-xs text-indigo-600 font-medium hover:underline">${involvedIds.length === members.length ? 'Bỏ chọn tất cả' : 'Chọn tất cả'}</button></div><div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1">${members.map(m => { const isSelected = involvedIds.includes(m.id); return `<button type="button" data-action="toggle-involved" data-id="${m.id}" class="px-3 py-1.5 rounded-full text-sm font-medium border flex items-center gap-1 ${isSelected ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-white text-gray-600 border-gray-200'}">${isSelected ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''} ${m.name}</button>`; }).join('')}</div></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="button" data-action="save-expense" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Lưu</button><button type="button" data-action="close-modal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Hủy</button></div>
                        </div>
                    </div>
                </div>`;
        };

        const render = () => {
            if (store.activeTripId) app.innerHTML = renderTripDetail();
            else app.innerHTML = renderTripList();
            modalContainer.innerHTML = renderExpenseModal();
            if (window.lucide) window.lucide.createIcons();
            
            // Restore focus
            const quickAdd = document.getElementById('quick-add-input');
            if (quickAdd && store.quickAddText) {
                quickAdd.focus();
                quickAdd.selectionStart = quickAdd.selectionEnd = quickAdd.value.length;
            }
        };

        // --- EVENT HANDLERS ---
        document.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (e.target.tagName === 'A' || e.target.closest('a')) e.preventDefault();
            if (!target) return;
            if (target.tagName === 'BUTTON' && target.type !== 'submit') e.preventDefault();

            const action = target.dataset.action;
            const id = target.dataset.id;

            if (action === 'select-trip') { store.activeTripId = id; store.isReadOnly = false; store.activeTab = 'expenses'; render(); }
            if (action === 'back-to-list') { store.activeTripId = null; render(); }
            if (action === 'switch-tab') { store.activeTab = target.dataset.tab; render(); }
            if (action === 'toggle-create-form') { store.isCreating = !store.isCreating; render(); if(store.isCreating) setTimeout(() => document.getElementById('new-trip-input')?.focus(), 50); }
            if (action === 'cancel-create') { store.isCreating = false; render(); }
            if (action === 'delete-trip') { if(confirm("Xóa chuyến đi này?")) await deleteTripFromDB(id); }
            if (action === 'share-trip') { const trip = store.trips.find(t => t.id === store.activeTripId); const encoded = encodeData(trip); navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}#share=${encoded}`); alert("Đã sao chép link chia sẻ!"); }
            if (action === 'enable-editing') { store.isReadOnly = false; render(); }
            
            if (action === 'remove-member') { 
                const trip = store.trips.find(t => t.id === store.activeTripId); 
                const updatedMembers = trip.members.filter(m => m.id !== id);
                await updateTripInDB({ ...trip, members: updatedMembers });
            }
            
            if (action === 'open-expense-modal') { store.expenseModalOpen = true; store.editingExpenseId = null; const trip = store.trips.find(t => t.id === store.activeTripId); store.expenseForm = { desc: '', amount: '', payerId: '', involvedIds: trip.members.map(m => m.id) }; render(); }
            if (action === 'close-modal') { store.expenseModalOpen = false; render(); }
            if (action === 'edit-expense') { const trip = store.trips.find(t => t.id === store.activeTripId); const expense = trip.expenses.find(e => e.id === id); store.expenseModalOpen = true; store.editingExpenseId = id; store.expenseForm = { desc: expense.description, amount: expense.amount, payerId: expense.payerId, involvedIds: expense.involvedMemberIds || trip.members.map(m => m.id) }; render(); }
            if (action === 'delete-expense') { if(confirm("Xóa?")) { const trip = store.trips.find(t => t.id === store.activeTripId); const updatedExpenses = trip.expenses.filter(e => e.id !== id); await updateTripInDB({ ...trip, expenses: updatedExpenses }); } }
            
            if (action === 'toggle-involved') { const id = target.dataset.id; if (store.expenseForm.involvedIds.includes(id)) store.expenseForm.involvedIds = store.expenseForm.involvedIds.filter(i => i !== id); else store.expenseForm.involvedIds.push(id); render(); }
            if (action === 'toggle-select-all') { const trip = store.trips.find(t => t.id === store.activeTripId); store.expenseForm.involvedIds = store.expenseForm.involvedIds.length === trip.members.length ? [] : trip.members.map(m => m.id); render(); }
            
            if (action === 'save-expense') {
                const desc = document.getElementById('ex-desc').value;
                const amount = parseInt(document.getElementById('ex-amount').value);
                const payerId = document.getElementById('ex-payer').value;
                if (!desc || isNaN(amount) || !payerId || store.expenseForm.involvedIds.length === 0) { alert("Vui lòng nhập đủ thông tin"); return; }
                
                const trip = store.trips.find(t => t.id === store.activeTripId);
                let updatedExpenses = [...trip.expenses];
                const expenseData = { id: store.editingExpenseId || generateId(), description: desc, amount, payerId, date: new Date().toISOString(), involvedMemberIds: store.expenseForm.involvedIds };
                
                if (store.editingExpenseId) updatedExpenses = updatedExpenses.map(e => e.id === store.editingExpenseId ? expenseData : e);
                else updatedExpenses.unshift(expenseData);
                
                store.expenseModalOpen = false;
                await updateTripInDB({ ...trip, expenses: updatedExpenses });
            }

            if (action === 'ai-quick-add') {
                const text = document.getElementById('quick-add-input').value.trim();
                if (!text) return;
                store.isAnalyzing = true; render();
                const trip = store.trips.find(t => t.id === store.activeTripId);
                const result = await parseExpenseWithAI(text, trip.members.map(m => m.name));
                store.isAnalyzing = false;
                if (result) {
                    store.expenseModalOpen = true; store.editingExpenseId = null;
                    const payer = trip.members.find(m => m.name.toLowerCase() === result.payerName?.toLowerCase());
                    store.expenseForm = { desc: result.description, amount: result.amount, payerId: payer?.id || '', involvedIds: trip.members.map(m => m.id) };
                }
                render();
            }
        });

        document.addEventListener('submit', async (e) => {
            e.preventDefault();
            const action = e.target.dataset.action;
            if (action === 'submit-create-trip') { const name = document.getElementById('new-trip-input').value; if(name) await createTripInDB(name); }
            if (action === 'add-member') { const name = document.getElementById('new-member-input').value; if(name) { const trip = store.trips.find(t => t.id === store.activeTripId); await updateTripInDB({ ...trip, members: [...trip.members, { id: generateId(), name }] }); store.newMemberName = ''; } }
        });

        document.addEventListener('input', (e) => {
            if (e.target.id === 'new-trip-input') store.newTripName = e.target.value;
            if (e.target.id === 'new-member-input') store.newMemberName = e.target.value;
            if (e.target.id === 'quick-add-input') store.quickAddText = e.target.value;
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.id === 'quick-add-input') document.querySelector('[data-action="ai-quick-add"]')?.click();
        });

        // Start Listening
        initFirebaseListener();
    </script>
</body>
</html>